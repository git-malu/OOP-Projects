package lm44_xw47.model.dataPacketAlgoCmd;

import common.DataPacketUserAlgoCmd;
import common.IUserCmd2ModelAdapter;
import common.IUser;
import common.IChatRoom;
import java.util.Map;
import common.DataPacketUser;

/**
* join team command
 *  * */
public class JoinTeamCmd extends DataPacketUserAlgoCmd<JoinTeamType> {
	private static final long serialVersionUID = -2797418269631586544L;

	private transient IUserCmd2ModelAdapter cmd2ModelAdpt;
	private transient Map<IUser, IChatRoom> teamsByUser;
	private transient Map<String, IChatRoom> teamsByName;
	private transient IUser userStub;

	@Override
	public void setCmd2ModelAdpt(IUserCmd2ModelAdapter cmd2ModelAdpt) {
		this.cmd2ModelAdpt = cmd2ModelAdpt;
	}

	public JoinTeamCmd(IUserCmd2ModelAdapter cmd2ModelAdpt, Map<IUser, IChatRoom> teamsByUser,
			Map<String, IChatRoom> teamsByName, IUser userStub) {
		this.cmd2ModelAdpt = cmd2ModelAdpt;
		this.teamsByUser = teamsByUser;
		this.teamsByName = teamsByName;
		this.userStub = userStub;
	}

	@Override
	public String apply(Class<?> index, DataPacketUser<JoinTeamType> host, String... params) {
		String teamName = host.getData().getTeamName();
		IUser sender = host.getSender();

		if (!teamsByUser.containsKey(sender)) {
			if (!teamsByName.containsKey(teamName)) {
				teamsByName.put(teamName, new ChatRoom(teamName));
			}
			IChatRoom team = teamsByName.get(teamName);
			teamsByUser.put(sender, team);
			try {
				sender.receive(
						new DataPacketUser<IInvitationType>(IInvitationType.class, new InvitationType(team), userStub));
				cmd2ModelAdpt.appendMsg("A user has joined a team. \n", "System: ");
			} catch (RemoteException e) {
				e.printStackTrace();
			}

		}
		return "";
	}
}
